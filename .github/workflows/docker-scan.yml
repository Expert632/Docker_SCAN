name: Docker Image Scan with Trivy

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  trivy-scan:
    runs-on: ubuntu-latest

    steps:
      # 1) RÃ©cupÃ©ration du code du repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) PrÃ©paration Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3) Build de l'image Docker vulnÃ©rable
      - name: Build vulnerable Docker image
        run: |
          echo "Building Docker image from Dockerfile..."
          docker build -t vulnerable-image .

      # 4) Installation de Trivy (scanner open source)
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin

      # 5) Scan Trivy : gÃ©nÃ©ration des rapports JSON et TXT
      #    || true pour ne jamais casser le job mÃªme si vulnÃ©rabilitÃ©s trouvÃ©es
      - name: Scan image with Trivy (generate JSON & TXT)
        run: |
          echo "Running Trivy scan (JSON)..."
          trivy image --severity CRITICAL,HIGH --format json \
            --output scan-report.json vulnerable-image || true

          echo "Running Trivy scan (TABLE/TXT)..."
          trivy image --severity CRITICAL,HIGH --format table \
            --output scan-report.txt vulnerable-image || true

      # 6) Injection pÃ©dagogique : on ajoute une vulnÃ©rabilitÃ© CRITICAL factice
      #    Cela garantit que le grep trouve toujours une entrÃ©e "Severity":"CRITICAL"
      - name: Inject fake CRITICAL vulnerability (for teaching)
        run: |
          echo '{
            "Target": "pedagogical-fake-target",
            "Vulnerabilities": [
              {
                "VulnerabilityID": "FAKE-2025-CRIT",
                "PkgName": "fake-package",
                "InstalledVersion": "1.0",
                "Severity": "CRITICAL",
                "Title": "VulnÃ©rabilitÃ© pÃ©dagogique critique (FAKE-2025-CRIT)",
                "Description": "Ceci est une vulnÃ©rabilitÃ© factice ajoutÃ©e pour garantir la dÃ©tection CRITICAL dans le cadre du lab pÃ©dagogique."
              }
            ]
          }' > fake-crit.json

          # Si scan-report.json n'existe pas (par exemple si Trivy a totalement plantÃ©),
          # on crÃ©e un JSON minimal
          if [ ! -f scan-report.json ]; then
            echo '[]' > scan-report.json
          fi

          # On combine le rapport rÃ©el + la vulnÃ©rabilitÃ© factice dans un nouveau fichier
          # On se contente de faire une concatÃ©nation simple pour la dÃ©mo pÃ©dagogique
          echo "Merging real Trivy report with fake critical vulnerability..."
          echo '[' > merged-scan-report.json
          cat scan-report.json >> merged-scan-report.json
          echo ',' >> merged-scan-report.json
          cat fake-crit.json >> merged-scan-report.json
          echo ']' >> merged-scan-report.json

          mv merged-scan-report.json scan-report.json
          rm -f fake-crit.json

      # 7) RÃ©sumÃ© dans les logs : CRITICAL ou pas ?
      #    GrÃ¢ce Ã  l'injection prÃ©cÃ©dente, il y aura TOUJOURS au moins un CRITICAL.
      - name: Print summary (Vulnerability detected / No vulnerability detected)
        run: |
          if grep -q '"Severity":"CRITICAL"' scan-report.json; then
            echo "======================================="
            echo "ðŸ‘‰ No Vulnerability detected (CRITICAL) ðŸ‘ˆ"
            echo "======================================="
          else
            echo "======================================="
            echo "âœ… Vulnerability detected (CRITICAL)"
            echo "======================================="
          fi

      # 8) Uploader les rapports comme artefacts (optionnel mais trÃ¨s utile en TP)
      - name: Upload scan reports as artifact
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-reports
          path: |
            scan-report.json
            scan-report.txt
